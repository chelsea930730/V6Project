<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… ëª©ë¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- ê´€ë¦¬ìì¼ ê²½ìš°ì—ë§Œ nav_admin.css ë¡œë“œ -->
    <link th:if="${currentUserEmail == 'admin@realestate.com'}" rel="stylesheet" th:href="@{/css/nav_admin.css}">
    <link rel="stylesheet" href="/css/chat.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        /* ì½ì§€ ì•Šì€ ì±„íŒ… ìŠ¤íƒ€ì¼ - í˜ì´ìŠ¤ë¶ ë©”ì‹ ì € ìŠ¤íƒ€ì¼ */
        .unread-chat {
            background-color: #e6f2ff !important; /* ë” ë°ì€ íŒŒë€ìƒ‰ ë°°ê²½ */
            border-left: 4px solid #4080ff !important; /* íŒŒë€ìƒ‰ ì™¼ìª½ í…Œë‘ë¦¬ ì¶”ê°€ */
        }

        .unread-chat .user-email,
        .unread-chat .last-message {
            font-weight: bold !important;
            color: #1c1e21 !important; /* ë” ì§„í•œ ê²€ì •ìƒ‰ */
        }

        /* ê¸°ì¡´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì•Œë¦¼ ìŠ¤íƒ€ì¼ ì œê±° */
        .unread-indicator {
            display: none !important; /* ì™„ì „íˆ ìˆ¨ê¹€ */
        }

        .user-name-container {
            display: flex;
            align-items: center;
        }

        /* ì±„íŒ… í•­ëª© ìŠ¤íƒ€ì¼ ê°œì„  */
        .chat-user-item {
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }
        
        .chat-user-item:hover {
            background-color: #f7f8fa !important;
        }
        
        /* ì‚­ì œ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            text-align: center;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .confirm-btn, .cancel-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .confirm-btn {
            background-color: #e53935;
            color: white;
        }
        
        .cancel-btn {
            background-color: #f5f5f5;
            color: #333;
        }
    </style>
</head>
<body>
    <!-- ê´€ë¦¬ììš© ë„¤ë¹„ê²Œì´ì…˜ (ê´€ë¦¬ìì¼ ê²½ìš°) -->
    <div th:if="${currentUserEmail == 'admin@realestate.com'}" th:replace="admin/nav_admin :: nav"></div>
    
    <!-- ì¼ë°˜ ì‚¬ìš©ììš© ë„¤ë¹„ê²Œì´ì…˜ (ê´€ë¦¬ìê°€ ì•„ë‹ ê²½ìš°) -->
    <div th:unless="${currentUserEmail == 'admin@realestate.com'}" id="navbar-placeholder"></div>

    <!-- ê´€ë¦¬ìì¼ ê²½ìš° ë ˆì´ì•„ì›ƒ -->
    <div th:if="${currentUserEmail == 'admin@realestate.com'}" class="container-fluid">
        <div class="row">
            <main class="col-md-10 ms-sm-auto px-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                    <h2>ì±„íŒ… ìš”ì²­ ëª©ë¡</h2>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div id="chat-users-container">
                            <div id="user-selection" class="user-selection"></div>
                        </div>
                    </div>
                </div>

                <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
                <div id="deleteModal" class="modal">
                    <div class="modal-content">
                        <h3>ì±„íŒ…ë°© ì‚­ì œ</h3>
                        <p>ì •ë§ë¡œ ì´ ì±„íŒ…ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                        <div class="modal-buttons">
                            <button id="confirmDelete" class="confirm-btn">ì˜ˆ</button>
                            <button id="cancelDelete" class="cancel-btn">ì•„ë‹ˆì˜¤</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ì¼ë°˜ ì‚¬ìš©ìì¼ ê²½ìš° ì ‘ê·¼ ì œí•œ ë ˆì´ì•„ì›ƒ -->
    <div th:unless="${currentUserEmail == 'admin@realestate.com'}" style="margin-top: 60px;">
        <div class="container mt-5">
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading">ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</h4>
                <p>ì£„ì†¡í•©ë‹ˆë‹¤. ì±„íŒ… ê´€ë¦¬ ëª©ë¡ì€ ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <hr>
                <p class="mb-0">ë©”ì¸ í˜ì´ì§€ë¡œ <a href="/" class="alert-link">ëŒì•„ê°€ê¸°</a></p>
            </div>
        </div>
    </div>

    <input type="hidden" id="currentUserEmail" th:value="${currentUserEmail}" />

    <!-- ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- ê´€ë¦¬ì/ì¼ë°˜ ì‚¬ìš©ì êµ¬ë¶„í•˜ì—¬ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script th:if="${currentUserEmail == 'admin@realestate.com'}" th:replace="admin/nav_admin :: nav-script"></script>
    <script th:unless="${currentUserEmail == 'admin@realestate.com'}">
        // ì¼ë°˜ ë„¤ë¹„ê²Œì´ì…˜ ë¡œë“œ í•¨ìˆ˜
        function loadDefaultNavigation() {
            fetch("/navi.html")
                .then(response => response.text())
                .then(data => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data, 'text/html');
                    
                    const header = doc.querySelector('header');
                    const footer = doc.querySelector('footer');
                    const style = doc.querySelector('style');
                    
                    document.getElementById("navbar-placeholder").innerHTML = header.outerHTML;
                    document.body.insertAdjacentHTML('beforeend', footer.outerHTML);
                    
                    if (!document.querySelector('style[data-navi-styles]')) {
                        style.setAttribute('data-navi-styles', '');
                        document.head.appendChild(style);
                    }
                    
                    // ë„¤ë¹„ê²Œì´ì…˜ ë¡œë“œ í›„ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
                    fetch("/user/index")
                        .then(response => response.json())
                        .then(data => {
                            const navMenu = document.getElementById("nav-menu");
                            
                            if (data.isLoggedIn) {
                                // ë¡œê·¸ì¸ëœ ê²½ìš°
                                navMenu.innerHTML = `
                                    <div class="nav-links">
                                        <a href="/cart" class="nav-link">ğŸ›’ Cart</a>
                                        <a href="/mypage/chat.html?user=admin@realestate.com" class="nav-link" id="chat-link">ì±„íŒ…</a>
                                        <a href="/mypage/mypage.html" class="nav-link">ë§ˆì´í˜ì´ì§€</a>
                                        <button class="logout-btn">LOGOUT</button>
                                    </div>
                                `;
                                
                                // ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                                document.querySelector('.logout-btn').addEventListener('click', function() {
                                    fetch("/user/logout", { method: "POST" })
                                        .then(() => {
                                            window.location.href = "/";
                                        })
                                        .catch(error => console.error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:", error));
                                });
                            } else {
                                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
                                navMenu.innerHTML = `
                                    <div class="auth-buttons">
                                        <a href="/user/login" class="login-btn">LOGIN</a>
                                    </div>
                                `;
                            }
                        })
                        .catch(error => {
                            console.error("ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", error);
                            // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ë¡œê·¸ì¸ ë²„íŠ¼ì„ í‘œì‹œ
                            const navMenu = document.getElementById("nav-menu");
                            if (navMenu) {
                                navMenu.innerHTML = `
                                    <div class="auth-buttons">
                                        <a href="/user/login" class="login-btn">LOGIN</a>
                                    </div>
                                `;
                            }
                        });
                })
                .catch(error => console.error("ë„¤ë¹„ê²Œì´ì…˜ ë¡œë”© ì˜¤ë¥˜:", error));
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ë¡œë“œ
        document.addEventListener("DOMContentLoaded", loadDefaultNavigation);
    </script>
    <script>
        var currentUserEmail = "";
        var selectedUserToDelete = ""; // ì‚­ì œí•  ì‚¬ìš©ì ì´ë©”ì¼ ì €ì¥ ë³€ìˆ˜
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì±„íŒ… ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener("DOMContentLoaded", function() {
            // ì´ë©”ì¼ ê°€ì ¸ì˜¤ê¸°
            var emailInput = document.getElementById('currentUserEmail');
            if (emailInput && emailInput.value) {
                currentUserEmail = emailInput.value;
            }
            
            // ê´€ë¦¬ì í™•ì¸
            if (currentUserEmail === "admin@realestate.com") {
                loadChatUsers();
            } else {
                // ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš° ì ‘ê·¼ ì œí•œ ë©”ì‹œì§€ í‘œì‹œë¨ (ì´ë¯¸ HTMLë¡œ ì²˜ë¦¬ë¨)
                console.log("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
            }

            // ëª¨ë‹¬ ê´€ë ¨ ìš”ì†Œ ì´ë²¤íŠ¸ ì„¤ì •
            const deleteModal = document.getElementById('deleteModal');
            const confirmDelete = document.getElementById('confirmDelete');
            const cancelDelete = document.getElementById('cancelDelete');

            // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
            if (cancelDelete) {
                cancelDelete.addEventListener('click', function() {
                    deleteModal.style.display = 'none';
                });
            }

            // í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì±„íŒ…ë°© ì‚­ì œ
            if (confirmDelete) {
                confirmDelete.addEventListener('click', function() {
                    if (selectedUserToDelete) {
                        // ì‚­ì œ ì¤‘ì„ì„ í‘œì‹œ
                        confirmDelete.disabled = true;
                        confirmDelete.textContent = "ì‚­ì œ ì¤‘...";
                        
                        // ì±„íŒ…ë°© ì‚­ì œ API í˜¸ì¶œ
                        fetch(`/api/chat/delete?partner=${selectedUserToDelete}`, {
                            method: 'DELETE'
                        })
                        .then(response => {
                            if (response.ok) {
                                // ì‚­ì œ ì„±ê³µ ì‹œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                                loadChatUsers();
                                deleteModal.style.display = 'none';
                            } else {
                                // ì‘ë‹µì´ OKê°€ ì•„ë‹Œ ê²½ìš° ì—ëŸ¬ ë©”ì‹œì§€ íŒŒì‹± ì‹œë„
                                return response.json().then(data => {
                                    throw new Error(data.error || 'ì±„íŒ…ë°© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                                }).catch(e => {
                                    if (e instanceof SyntaxError) {
                                        throw new Error('ì±„íŒ…ë°© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                                    }
                                    throw e;
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting chat room:', error);
                            alert(error.message || 'ì±„íŒ…ë°© ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        })
                        .finally(() => {
                            // ë²„íŠ¼ ìƒíƒœ ë³µì›
                            confirmDelete.disabled = false;
                            confirmDelete.textContent = "ì˜ˆ";
                            deleteModal.style.display = 'none';
                        });
                    }
                });
            }

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            window.addEventListener('click', function(event) {
                if (event.target === deleteModal) {
                    deleteModal.style.display = 'none';
                }
            });
        });
        
        // ì±„íŒ… ìš”ì²­í•œ ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadChatUsers() {
            fetch('/api/chat/active-users')
                .then(response => response.json())
                .then(users => {
                    const userSelectionDiv = document.getElementById('user-selection');
                    userSelectionDiv.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
                    
                    if (users.length === 0) {
                        userSelectionDiv.innerHTML = '<p>í˜„ì¬ ì±„íŒ… ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        return;
                    }
                    
                    users.forEach(user => {
                        // ì„ì˜ì˜ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ í‘œì‹œ (ì„œë²„ì—ì„œ ì œê³µí•˜ëŠ” ê²½ìš° í•´ë‹¹ ê°’ ì‚¬ìš©)
                        // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì„œë²„ APIì—ì„œ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ë¥¼ ë°›ì•„ì™€ì•¼ í•¨
                        const unreadCount = Math.floor(Math.random() * 5); // ì„ì˜ì˜ ê°’ (0-4)
                        
                        const chatItem = document.createElement('div');
                        chatItem.className = 'chat-user-item';
                        
                        let unreadBadge = '';
                        if (unreadCount > 0) {
                            unreadBadge = `<span class="unread-indicator">${unreadCount}</span>`;
                        }
                        
                        chatItem.innerHTML = `
                            <div class="user-info">
                                <div>
                                    <span class="user-email">${user.email}</span>
                                    ${unreadBadge}
                                </div>
                                <span class="last-message-time">${new Date(user.lastMessageTime).toLocaleString()}</span>
                            </div>
                            <div class="last-message">${user.lastMessage || 'ìƒˆë¡œìš´ ì±„íŒ…'}</div>
                            <div class="buttons-container">
                                <button class="start-chat-btn" onclick="startChat('${user.email}')">ì±„íŒ…í•˜ê¸°</button>
                                <button class="delete-chat-btn" onclick="showDeleteConfirm('${user.email}')">ì‚­ì œí•˜ê¸°</button>
                            </div>
                        `;
                        userSelectionDiv.appendChild(chatItem);
                    });
                })
                .catch(error => console.error("Error fetching chat users:", error));
        }
        
        // ì±„íŒ… ì‹œì‘
        function startChat(userEmail) {
            window.location.href = `/mypage/chat.html?user=${userEmail}`;
        }

        // ì‚­ì œ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
        function showDeleteConfirm(userEmail) {
            selectedUserToDelete = userEmail;
            const deleteModal = document.getElementById('deleteModal');
            deleteModal.style.display = 'flex';
        }
    </script>
</body>
</html>
