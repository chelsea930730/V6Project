<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="stylesheet" href="/css/chat.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- ê´€ë¦¬ìì¼ ê²½ìš°ì—ë§Œ nav_admin.css ë¡œë“œ - ì—­í•  ê¸°ë°˜ìœ¼ë¡œ í™•ì¸ -->
    <link th:if="${role == 'ADMIN'}" rel="stylesheet" href="/css/nav_admin.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        /* URL ì…ë ¥ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .attachment-container {
            display: none;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .attachment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .attachment-content {
            display: flex;
            gap: 10px;
        }
        
        .attachment-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .attachment-button {
            background-color: #4682B4;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
        }
        
        .close-attachment {
            background: none;
            border: none;
            cursor: pointer;
            color: #888;
        }
        
        .close-attachment:hover {
            color: #555;
        }
        
        /* ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ */
        .media-btn.active {
            background-color: #4682B4;
            color: white;
        }
        
        /* ì±„íŒ… ì»¨í…Œì´ë„ˆ ë„ˆë¹„ ê³ ì • ìŠ¤íƒ€ì¼ */
        #chat-container {
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body th:class="${role == 'ADMIN'} ? 'admin-layout' : ''">
    <div id="navbar-placeholder"></div>

    <div id="chat-content" th:class="${role == 'ADMIN'} ? 'chat-content-admin' : ''">
        <h1 id="chatRoomTitle">ì±„íŒ…</h1>

        <div id="chat-container">
            <div id="messages" class="messages"></div>
        </div>

        <!-- URL ì…ë ¥ ì˜ì—­ (í† ê¸€) -->
        <div id="urlInputContainer" class="attachment-container">
            <div class="attachment-header">
                <span>URL ì…ë ¥</span>
                <button id="closeUrlInput" class="close-attachment"><i class="fas fa-times"></i></button>
            </div>
            <div class="attachment-content">
                <input type="text" id="urlInput" placeholder="https://..." class="attachment-input">
                <button id="addUrlBtn" class="attachment-button">ì¶”ê°€</button>
            </div>
        </div>

        <div class="input-container">
            <div class="media-buttons">
                <button id="urlButton" class="media-btn" title="URL ì²¨ë¶€">
                    <i class="fas fa-link"></i>
                </button>
            </div>
            <input id="message" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
            <button id="sendButton" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>

    <input type="hidden" id="currentUserEmail" th:value="${currentUserEmail}" />
    <input type="hidden" id="userRole" th:value="${role}" />

    <script>
        // ì—­í• ì— ë”°ë¥¸ ë„¤ë¹„ê²Œì´ì…˜ ë¡œë“œ í•¨ìˆ˜
        function loadNavigationByRole() {
            // HTML ìš”ì†Œì—ì„œ ì—­í•  ê°’ì„ ê°€ì ¸ì˜´
            const roleElement = document.getElementById('userRole');
            if (roleElement && roleElement.value === 'ADMIN') {
                console.log("ê´€ë¦¬ììš© ë„¤ë¹„ê²Œì´ì…˜ ë¡œë“œ");
                // ê´€ë¦¬ìì¸ ê²½ìš° - ì‚¬ì´ë“œë°” í˜•íƒœì˜ nav_admin.html ë¡œë“œ
                loadAdminNavigation();
            } else {
                console.log("ì¼ë°˜ ì‚¬ìš©ììš© ë„¤ë¹„ê²Œì´ì…˜ ë¡œë“œ");
                // ì¼ë°˜ ì‚¬ìš©ìì¸ ê²½ìš° - ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ navi.html ë¡œë“œ
                loadUserNavigation();
            }
        }
        
        // ê´€ë¦¬ììš© ë„¤ë¹„ê²Œì´ì…˜ ë¡œë“œ í•¨ìˆ˜
        function loadAdminNavigation() {
            fetch("/nav_admin.html")
                .then(response => {
                    if (!response.ok) {
                        throw new Error("ê´€ë¦¬ì ë„¤ë¹„ê²Œì´ì…˜ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    return response.text();
                })
                .then(html => {
                    // bodyì— admin-layout í´ë˜ìŠ¤ ì¶”ê°€
                    document.body.classList.add('admin-layout');
                    
                    // ë„¤ë¹„ê²Œì´ì…˜ ì‚½ì…
                    document.getElementById("navbar-placeholder").innerHTML = html;
                    
                    // nav_admin.css ì¶”ê°€ (ì´ë¯¸ ì¶”ê°€ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°)
                    if (!document.querySelector('link[href="/css/nav_admin.css"]')) {
                        const cssLink = document.createElement('link');
                        cssLink.rel = 'stylesheet';
                        cssLink.href = '/css/nav_admin.css';
                        document.head.appendChild(cssLink);
                    }
                    
                    // nav_admin.js ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
                    const script = document.createElement('script');
                    script.src = '/js/nav_admin.js';
                    document.body.appendChild(script);
                    
                    // ê´€ë¦¬ì ì‚¬ì´ë“œë°” ë ˆì´ì•„ì›ƒì— ë§ê²Œ ìŠ¤íƒ€ì¼ ì¡°ì •
                    const style = document.createElement('style');
                    style.textContent = `
                        .admin-layout {
                            min-height: 100vh;
                            display: flex;
                        }
                        
                        #navbar-placeholder {
                            flex: 0 0 250px;
                            position: fixed;
                            height: 100vh;
                            z-index: 100;
                        }
                        
                        #chat-content {
                            flex: 1;
                            margin-left: 250px; /* ì‚¬ì´ë“œë°” ë„ˆë¹„ì™€ ë™ì¼í•˜ê²Œ ì„¤ì • */
                            padding: 20px;
                            width: calc(100% - 250px);
                        }
                        
                        #chat-container {
                            width: 100%;
                            max-width: 1200px;
                        }
                        
                        .input-container {
                            width: 100%;
                            max-width: 1200px;
                        }
                        
                        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ ë³´ì™„ */
                        .admin-sidebar {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 250px;
                            height: 100vh;
                            background-color: #6a99cd;
                            color: white;
                            padding: 20px 0;
                            z-index: 1000;
                        }
                    `;
                    document.head.appendChild(style);
                })
                .catch(error => {
                    console.error("ê´€ë¦¬ì ë„¤ë¹„ê²Œì´ì…˜ ë¡œë”© ì˜¤ë¥˜:", error);
                    // ì—ëŸ¬ ë°œìƒ ì‹œ ì¼ë°˜ ë„¤ë¹„ê²Œì´ì…˜ ë¡œë“œ
                    loadUserNavigation();
                });
        }
        
        // ì¼ë°˜ ì‚¬ìš©ììš© ë„¤ë¹„ê²Œì´ì…˜ ë¡œë“œ í•¨ìˆ˜
        function loadUserNavigation() {
            fetch("/navi.html")
                .then(response => {
                    if (!response.ok) {
                        throw new Error("ë„¤ë¹„ê²Œì´ì…˜ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    return response.text();
                })
                .then(data => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data, 'text/html');
                    
                    const header = doc.querySelector('header');
                    const footer = doc.querySelector('footer');
                    const style = doc.querySelector('style');
                    
                    document.getElementById("navbar-placeholder").innerHTML = header.outerHTML;
                    document.body.insertAdjacentHTML('beforeend', footer.outerHTML);
                    
                    if (!document.querySelector('style[data-navi-styles]')) {
                        style.setAttribute('data-navi-styles', '');
                        document.head.appendChild(style);
                    }
                    
                    // ë„¤ë¹„ê²Œì´ì…˜ ë¡œë“œ í›„ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
                    fetch("/user/index")
                        .then(response => response.json())
                        .then(data => {
                            const navMenu = document.getElementById("nav-menu");
                            // ê´€ë¦¬ì ì—¬ë¶€ë¥¼ ì—­í• ë¡œ í™•ì¸
                            const isAdmin = data.role === "ADMIN";
                            
                            if (data.isLoggedIn) {
                                // ë¡œê·¸ì¸ëœ ê²½ìš°
                                if (isAdmin) {
                                    // ê´€ë¦¬ììš© ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´
                                    navMenu.innerHTML = `
                                        <div class="nav-links">
                                            <a href="/admin/dashboard" class="nav-link">âš™ï¸ Dashboard</a>
                                            <a href="/mypage/chat-list.html" class="nav-link" id="chat-link">ì±„íŒ… ê´€ë¦¬</a>
                                            <button class="logout-btn">LOGOUT</button>
                                        </div>
                                    `;
                                } else {
                                    // ì¼ë°˜ ì‚¬ìš©ììš© ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´
                                    navMenu.innerHTML = `
                                        <div class="nav-links">
                                            <a href="/cart" class="nav-link">ğŸ›’ Cart</a>
                                            <a href="/mypage/chat.html?user=admin@realestate.com" class="nav-link" id="chat-link">ì±„íŒ…</a>
                                            <a href="/mypage/mypage.html" class="nav-link">ë§ˆì´í˜ì´ì§€</a>
                                            <button class="logout-btn">LOGOUT</button>
                                        </div>
                                    `;
                                }
                                
                                // ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                                document.querySelector('.logout-btn').addEventListener('click', function() {
                                    fetch("/user/logout", { method: "POST" })
                                        .then(() => {
                                            window.location.href = "/";
                                        })
                                        .catch(error => console.error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:", error));
                                });
                            } else {
                                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
                                navMenu.innerHTML = `
                                    <div class="auth-buttons">
                                        <a href="/user/login" class="login-btn">LOGIN</a>
                                    </div>
                                `;
                            }
                            
                            // ì¼ë°˜ ì‚¬ìš©ì ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ ì ìš©
                            const normalUserStyle = document.createElement('style');
                            normalUserStyle.textContent = `
                                body {
                                    padding-top: 80px;
                                }
                            `;
                            document.head.appendChild(normalUserStyle);
                        })
                        .catch(error => {
                            console.error("ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", error);
                            // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ë¡œê·¸ì¸ ë²„íŠ¼ì„ í‘œì‹œ
                            const navMenu = document.getElementById("nav-menu");
                            if (navMenu) {
                                navMenu.innerHTML = `
                                    <div class="auth-buttons">
                                        <a href="/user/login" class="login-btn">LOGIN</a>
                                    </div>
                                `;
                            }
                        });
                })
                .catch(error => console.error("ë„¤ë¹„ê²Œì´ì…˜ ë¡œë”© ì˜¤ë¥˜:", error));
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—­í• ì— ë§ëŠ” ë„¤ë¹„ê²Œì´ì…˜ ë¡œë“œ
        document.addEventListener("DOMContentLoaded", loadNavigationByRole);
    </script>

    <script src="/js/chat.js" defer></script>
</body>
</html>