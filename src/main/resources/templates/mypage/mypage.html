<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>마이 페이지</title>
	<link th:href="@{/css/mypage.css}" rel="stylesheet" />
	<script th:src="@{/js/navbar.js}" defer></script>
	<script th:src="@{/js/mypage.js}" defer></script>
	<meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}" />
</head>
<body>
<div id="navbar-placeholder"></div>

<main class="mypage-container">
	<h1>마이 페이지</h1>
	<p class="sub-heading">당신이 예약한 건물을 확인하세요!</p>

	<!-- CSRF 토큰을 hidden 필드로 추가 -->
	<input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />

	<section class="reservation-section">
		<h2>예약 리스트</h2>

		<!-- 성공/오류 메시지 표시 -->
		<div th:if="${success}" class="alert alert-success">
			<span th:text="${success}"></span>
		</div>
		<div th:if="${error}" class="alert alert-danger">
			<span th:text="${error}"></span>
		</div>

		<table class="reservation-table">
			<thead>
			<tr>
				<th>예약번호</th>
				<th>상담 날짜</th>
				<th>계약 현황</th>
				<th>문의사항</th>
				<th>채팅 바로가기</th>
				<th>예약 상세보기</th>
			</tr>
			</thead>
			<tbody>
			<!-- 예약 대기 및 예약 중인 항목만 표시 -->
			<tr th:each="reservation : ${activeReservations}" 
				th:if="${reservation.status.name() == 'PENDING' || reservation.status.name() == 'CONFIRMED'}">
				<td th:text="${'NO.' + reservation.reservationId}">NO.000006</td>
				<td th:text="${#temporals.format(reservation.reservedDate, 'yyyy-MM-dd')}">2025-03-22</td>
				<td>
					<!-- 편집 불가능한 계약 현황 셀렉트 박스 -->
					<select class="status-select" disabled>
						<option value="PENDING" th:selected="${reservation.status.name() == 'PENDING'}">예약 대기</option>
						<option value="CONFIRMED" th:selected="${reservation.status.name() == 'CONFIRMED'}">예약 중</option>
						<option value="COMPL" th:selected="${reservation.status.name() == 'COMPL'}">계약 완료</option>
						<option value="CANCELLED" th:selected="${reservation.status.name() == 'CANCELLED'}">계약 불가</option>
					</select>
				</td>
				<td th:text="${reservation.message != null && #strings.length(reservation.message) > 10 ?
							#strings.substring(reservation.message, 0, 10) + '...' :
							(reservation.message != null ? reservation.message : '-')}">문의사항...</td>
				<td><button class="chat-btn">채팅하기</button></td>
				<td>
					<a th:href="@{'/mypage/reservation/' + ${reservation.reservationId}}" class="view-btn">상세보기</a>
				</td>
			</tr>
			<tr th:if="${#lists.isEmpty(activeReservations)}">
				<td colspan="6" class="empty-message">진행 중인 예약이 없습니다.</td>
			</tr>
			</tbody>
		</table>
	</section>

	<section class="history-section">
		<h2>상담 완료 목록</h2>
		<table class="history-table">
			<thead>
			<tr>
				<th>예약번호</th>
				<th>상담 날짜</th>
				<th>계약 현황</th>
				<th>문의사항</th>
				<th>예약 상세보기</th>
			</tr>
			</thead>
			<tbody>
			<!-- 계약 완료 또는 계약 불가 상태인 항목 표시 -->
			<tr th:each="reservation : ${allReservations}" 
				th:if="${reservation.status.name() == 'COMPL' || reservation.status.name() == 'CANCELLED'}">
				<td th:text="${'NO.' + reservation.reservationId}">NO.000001</td>
				<td th:text="${#temporals.format(reservation.reservedDate, 'yyyy-MM-dd')}">2022-10-22</td>
				<td>
					<!-- 편집 불가능한 계약 현황 셀렉트 박스 -->
					<select class="status-select" disabled>
						<option value="PENDING" th:selected="${reservation.status.name() == 'PENDING'}">예약 대기</option>
						<option value="CONFIRMED" th:selected="${reservation.status.name() == 'CONFIRMED'}">예약 중</option>
						<option value="COMPL" th:selected="${reservation.status.name() == 'COMPL'}">계약 완료</option>
						<option value="CANCELLED" th:selected="${reservation.status.name() == 'CANCELLED'}">계약 불가</option>
					</select>
				</td>
				<td th:text="${reservation.message != null && #strings.length(reservation.message) > 10 ?
							#strings.substring(reservation.message, 0, 10) + '...' :
							(reservation.message != null ? reservation.message : '-')}">문의사항...</td>
				<td>
					<a th:href="@{'/mypage/reservation/' + ${reservation.reservationId}}" class="view-btn">상세보기</a>
				</td>
			</tr>
			<tr th:if="${#lists.isEmpty(allReservations)}">
				<td colspan="5" class="empty-message">완료된 상담 내역이 없습니다.</td>
			</tr>
			</tbody>
		</table>
	</section>
</main>

<div id="footer-placeholder"></div>

<!-- 모달 추가 -->
<div id="imageModal" class="modal">
	<span class="close">&times;</span>
	<img class="modal-content" id="modalImage">
</div>
</body>


</html>